var app_version="0.1.0",units=env.table.units,min_x=env.table.x.min,max_x=env.table.x.max,min_y=env.table.y.min,max_y=env.table.y.max,plotter_exceeded=!1,motor_speed=env.motor.speed,ball_size=env.ball.diameter,pattern_config_overlay=!1,coordinate_overlay=!0,distance,draw_iteration=0,gCodeCommand=env.gcode.command,plotter_format_select,pattern_select,previous_pattern,path,recalculate_pattern=env.recalculate_pattern,Patterns={cycloid:new Cycloid,diameters:new Diameters,egg:new Egg,farris:new Farris,fermatspiral:new FermatSpiral,fibonacci:new Fibonacci,fibonaccilollipops:new FibonacciLollipops,frame:new Frame,gravity:new Gravity,heart:new Heart,lindenmayer:new Lindenmayer,lissajous:new Lissajous,rhodonea:new Rhodonea,shapemorph:new ShapeMorph,shapespin:new ShapeSpin,spiral:new Spiral,logspiral:new LogarithmicSpiral,spokes:new Spokes,star:new Star,superellipse:new Superellipse,wigglyspiral:new WigglySpiral,zigzag:new ZigZag};function setup(){frameRate(10);var canvas=createCanvas(648,648).parent("canvas-holder"),pattern_select_div=createDiv("<label>Pattern</label>").parent("pattern-selector");pattern_select=createSelect().parent(pattern_select_div).attribute("name","pattern");var pattern_select_menu=document.querySelector("#pattern-selector > div > select");const entries=Object.entries(Patterns);for(const[pattern_key,pattern_object]of entries)pattern_select.option(pattern_object.name,pattern_object.key);pattern_select.selected("spiral"),pattern_select.changed(patternSelectEvent);var local_storage_pattern=localStorage.getItem("lastPattern");local_storage_pattern&&pattern_select.selected(local_storage_pattern);let url_params=getURLParams();var loaded_patterns;url_params.pattern&&pattern_select.selected(url_params.pattern),previous_pattern=pattern_select.value(),loadPatternConfig(pattern_select.value()),(plotter_format_select=createSelect().attribute("name",key).parent("#plotter-format")).option("Cartesian","cartesian"),plotter_format_select.option("Polar","polar"),plotter_format_select.selected(env.table.format),plotter_format_select.changed(display_config_values),display_config_values(),downloadButton=createButton("Download").parent("download"),downloadButton.mousePressed(download),patternSelectEvent(!1)}function draw(){background(68);var selected_pattern=pattern_select.value();for("draw"==selected_pattern&&(recalculate_pattern=!0),recalculate_pattern&&(path=Patterns[selected_pattern].draw(),recalculate_pattern=env.recalculate_pattern),document.querySelector("#pattern-controls input[name=reverse]")&&(Patterns[selected_pattern].config.reverse.value=document.querySelector("#pattern-controls input[name=reverse]").checked,Patterns[selected_pattern].config.reverse.value&&path.reverse()),void 0!==Patterns[selected_pattern].path_sampling_optimization&&(path=optimizePath(path,Patterns[selected_pattern].path_sampling_optimization)),drawTable(path_exceeds_plotter(path)),drawPath(path,2,!1,!0,coordinate_overlay),distance=0,i=1;i<path.length;i++)distance+=sqrt(pow(path[i][0]-path[i-1][0],2)+pow(path[i][1]-path[i-1][1],2));select("#pattern-instructions").html(nfc(path.length)),select("#pattern-distance").html(nfc(distance,1)+" "+units),select("#pattern-time").html(nfc(distance/motor_speed,1)+" minutes"),pattern_config_overlay&&draw_pattern_config(Patterns[selected_pattern]),draw_iteration++}function draw_pattern_config(pattern){var base_unit=12;noStroke(),fill(255),textAlign(LEFT),push(),translate(3,3),text("Pattern: "+pattern.name,0,12);var j=27;Object.keys(pattern.config).forEach(key=>{text(key+": "+pattern.config[key].value,0,j),j+=15}),pop(),noStroke(),fill(128,128,128),textAlign(CENTER),text("Created at https://markroland.github.io/sand-table-pattern-maker",width/2,height-72)}function path_exceeds_plotter(path){const arrayColumn=(arr,n)=>arr.map(a=>a[n]);return x_coordinates=arrayColumn(path,0),y_coordinates=arrayColumn(path,1),Math.min(...x_coordinates)<-(max_x-min_x)/2||(Math.max(...x_coordinates)>max_x/2||(Math.min(...y_coordinates)<-(max_y-min_y)/2||Math.max(...y_coordinates)>max_y/2))}function patternSelectEvent(recalculate_pattern=!0){select("#pattern-controls").html("");var selected_pattern=pattern_select.value();localStorage.setItem("lastPattern",selected_pattern),loadPatternConfig(selected_pattern),recalculate_pattern&&savePatternConfig(previous_pattern),previous_pattern=selected_pattern;let controls=new Array;const configs=Object.entries(Patterns[selected_pattern].config);for(const[key,val]of configs){var control=new Object;if(control.div=createDiv("<label>"+val.name+"</label>").parent("pattern-controls").addClass("pattern-control"),"createSelect"==val.input.type){control.input=createSelect().attribute("name",key).parent(control.div).addClass(val.input.class);const entries=Object.entries(val.input.options);for(const[key,object]of entries)control.input.option(object,key);val.value&&control.input.selected(val.value)}else"createSlider"==val.input.type?control.input=createSlider(val.input.params[0],val.input.params[1],val.value?val.value:val.input.params[2],val.input.params[3]).attribute("name",key).parent(control.div).addClass(val.input.class):"createCheckbox"==val.input.type?(control.input=createInput(val.input.params[0],val.input.params[1],val.input.params[2]).attribute("type","checkbox").attribute("name",key).attribute("checkbox",null).parent(control.div),1==val.input.params[2]?control.input.attribute("checked","checked"):val.value&&control.input.attribute("checked","checked")):"createInput"==val.input.type?control.input=createInput(val.value?val.value:val.input.params[0],val.input.params[1]).attribute("name",key).parent(control.div):"createTextarea"==val.input.type&&(control.input=createElement("textarea",val.value?val.value:val.input.value).attribute("rows",val.input.attributes.rows).attribute("cols",val.input.attributes.cols).attribute("name",key).parent(control.div));if(control.input.changed((function(){recalculate_pattern=!0})),val.input.displayValue){let radius_value=createSpan("0").parent(control.div)}controls.push(control)}document.title="Sand Pattern | "+Patterns[selected_pattern].name,void 0!==Patterns[pattern_select.value()]&&updateURL(pattern_select.value())}function display_config_values(){env.table.format=plotter_format_select.value(),"cartesian"==env.table.format?(select("#plotter-max_x").html(min_x+" - "+max_x+" "+units),select("#plotter-max_y").html(min_y+" - "+max_y+" "+units)):(select("#plotter-max_x").html("NA"),select("#plotter-max_y").html("NA")),select("#plotter-motor_speed").html(motor_speed+" "+units+"/min"),select("#plotter-ball_size").html(ball_size+" "+units)}function optimizePath(path,min_distance){var filtered_path=new Array;return filtered_path.push(path[0]),path.forEach((function(element,index){var fp_last=filtered_path[filtered_path.length-1],step_distance;sqrt(pow(element[0]-fp_last[0],2)+pow(element[1]-fp_last[1],2))>min_distance&&filtered_path.push(element)})),filtered_path}function download(){let filename="pattern";var selected_pattern=pattern_select.value();if(void 0!==Patterns[selected_pattern]&&(filename+="-"+Patterns[selected_pattern].key),draw_pattern_config(Patterns[selected_pattern]),"cartesian"==env.table.format)save(createGcode(path,gCodeCommand),filename,"gcode");else if("polar"==env.table.format){let thr_path=new thetaRho(path);save(thr_path.convert(path),filename,"thr")}}function keyTyped(){"c"===key?coordinate_overlay=!coordinate_overlay:"o"===key&&(pattern_config_overlay=!pattern_config_overlay)}function updateURL(selected_pattern){let query_string="?pattern="+selected_pattern;const entries=Object.entries(Patterns[selected_pattern].config);history.replaceState({id:"homepage"},document.title,query_string)}function savePatternConfig(previous_pattern){localStorage.setItem("appVersion",app_version),localStorage.setItem("lastSaved",new Date),localStorage.setItem("v"+app_version+"_"+previous_pattern,JSON.stringify(Patterns[previous_pattern].config))}function loadPatternConfig(selected_pattern){var loaded_state=JSON.parse(localStorage.getItem("v"+app_version+"_"+selected_pattern));loaded_state&&(Patterns[selected_pattern].config=loaded_state)}